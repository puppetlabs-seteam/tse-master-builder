#!groovy
import org.yaml.snakeyaml.Yaml
import groovy.json.JsonOutput
import groovy.json.JsonSlurperClassic

config = [:]
imageId = ''

node ('tse-master-builder-vmware') {
  stage("Setup") {
    git branch: env.BUILD_BRANCH, changelog: false, poll: false, url: 'https://github.com/puppetlabs-seteam/tse-master-builder.git'

    config['source_ova'] = env.SOURCE_OVA
    config['s3_bucket'] = env.S3_BUCKET
    config['s3_key'] = env.S3_KEY
    config['build_notice'] = env.BUILD_NOTICE

    if (!config['source_ova']?.trim()) {
      error("FAILED - SOURCE_OVA parameter cannot be left empty!")
    }

    if (!config['s3_bucket']?.trim()) {
      error("FAILED - S3_BUCKET parameter cannot be left empty!")
    }

    if (!config['s3_key']?.trim()) {
      error("FAILED - S3_KEY parameter cannot be left empty!")
    }

    if (!config['build_notice']?.trim()) {
      error("FAILED - BUILD_NOTICE parameter cannot be left empty!")
    }

  }

  stage("Upload/Convert") {
    withEnv([
      "PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/MacGPG2/bin"
    ]) {
      def bucket = [:]
      bucket["S3Bucket"] = config['s3_bucket']
      bucket["S3Key"] = config['s3_key']

      def jsonconfig = [:]
      jsonconfig['Description'] = "SE Demo Puppetmaster OVA"
      jsonconfig['Format'] = "ova"
      jsonconfig['UserBucket'] = bucket
      def clioption = [ jsonconfig ]
      def json = JsonOutput.toJson(clioption)
      writeFile file: "containers.json", text: json

      // Kickoff job
      def json1 = sh(
        returnStdout: true,
        script: "aws ec2 import-image --license-type BYOL  --disk-containers file://containers.json --region us-west-2"
      )
      def ami_job = new JsonSlurperClassic().parseText(json1)['ImportTaskId']

      //Get the new AMI id
      def json2 = sh(returnStdout: true,
                     script: "aws ec2 describe-import-image-tasks --import-task-ids ${ami_job} --region us-west-2"
                    )

      //Wait for it to complete
      timeout(time: 2, unit: 'HOURS'){
        waitUntil {
          def json3 = sh(returnStdout: true,
                         script: "aws ec2 describe-import-image-tasks --import-task-ids ${ami_job} --region us-west-2"
                        )
          def status = new JsonSlurperClassic().parseText(json3)['ImportImageTasks'][0]['Status']

          if (status == 'completed'){
            imageId = new JsonSlurperClassic().parseText(json3)['ImportImageTasks'][0]['ImageId']
            sh("aws ec2 create-tags --resources ${imageId} --tags Key=Name,Value=${config['source_ova']} --region us-west-2")

            emailext body: "New SE Demo Env AMI has been published!\n\nSource OVA: ${config['source_ova']}\n\nNew AMI: ${imageId}", subject: "[SE Demo Environment] - New AMI Released! (${imageId} from source ${config['source_ova']})", to: "${config['build_notice']}", replyTo: 'noreply@puppet.com'

            return true
          } else {
            sleep 300
            return false
          }

        }
      }
    }
  }
}
